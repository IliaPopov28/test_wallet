# API Сервиса Кошелька

Простой RESTful API для управления балансами кошельков. Поддерживает операции пополнения, списания и получения баланса с упором на параллельную обработку запросов и целостность данных.

## Возможности
- Создание кошелька при первом пополнении.
- Пополнение счёта кошелька.
- Списание средств с кошелька.
- Получение текущего баланса кошелька.
- Использует PostgreSQL для хранения данных.
- Все сервисы контейнеризированы с помощью Docker.

## Необходимые утилиты
- [Docker](https://www.docker.com/get-started)
- [Docker Compose](https://docs.docker.com/compose/install/)

## Начало работы

1.  **Склонируйте репозиторий:**
    ```bash
    git clone <your-repo-url>
    cd test_wallet
    ```

2.  **Конфигурация:**
    Проект использует файл `config.env` для настроек. В репозитории есть пример. Значения по умолчанию настроены для работы с предоставленным `docker-compose.yml`.

    ```env
    PORT=8080
    # Строка подключения к PostgreSQL внутри сети Docker
    DB_URL="postgres://postgres:secret@db:5432/wallets?sslmode=disable"
    # Максимальное количество подключений к базе данных
    DB_MAX_CONNS=50
    ```

3.  **Сборка и запуск приложения:**
    Используйте Docker Compose для сборки Go-приложения, его запуска и старта базы данных PostgreSQL.
    ```bash
    docker-compose up --build -d
    ```
    API будет доступен по адресу `http://localhost:8080`.

## Эндпоинты API

Базовый URL для API: `/api/v1`.

### Операции с кошельком
- `POST /api/v1/wallet`
- Этот единый эндпоинт обрабатывает как пополнения, так и списания.

**Тело запроса (Пополнение):**
```json
{
    "walletId": "a55fc378-18e4-4c5d-8edd-97c3292c45d0",
    "operationType": "DEPOSIT",
    "amount": 100.50
}
```

**Тело запроса (Списание):**
```json
{
    "walletId": "a55fc378-18e4-4c5d-8edd-97c3292c45d0",
    "operationType": "WITHDRAW",
    "amount": 50.00
}
```

**Успешные ответы:**
- `201 Created`: Когда новый кошелек создается при первом пополнении.
- `200 OK`: Для всех остальных успешных операций.
- Тело ответа содержит новый баланс.
  ```json
  {
      "balance": "150.50"
  }
  ```

**Ответы с ошибками:**
- `400 Bad Request`: Некорректное тело запроса или параметры.
- `404 Not Found`: Кошелек не найден для операций списания или получения баланса.
- `409 Conflict`: Недостаточно средств для списания.
- `503 Service Unavailable`: Внутренняя ошибка сервера, часто из-за проблем с подключением к БД или сбоев транзакций.

### Получение баланса кошелька
- `GET /api/v1/wallets/{wallet_id}`

**Пример URL:**
`http://localhost:8080/api/v1/wallets/a55fc378-18e4-4c5d-8edd-97c3292c45d0`

**Успешный ответ (`200 OK`):**
```json
{
    "balance": "150.50"
}
```

## Запуск тестов

### Unit- и интеграционные тесты
Чтобы запустить все тесты, включая интеграционные (которые создают временный контейнер с Postgres), выполните команду:
```bash
go test ./...
```

## Нагрузочное тестирование
Я использовал `hey` для нагрузочного тестирования. Вы можете установить его через `go install github.com/rakyll/hey@latest`.

**Пример нагрузочного теста на пополнение:**
Эта команда отправляет 7000 запросов с 50 одновременными клиентами.
```bash
hey -n 7000 -c 50 -m POST -H "Content-Type: application/json" -d '{"walletId":"a55fc378-18e4-4c5d-8edd-97c3292c45d0","operationType":"DEPOSIT","amount":1}' http://localhost:8080/api/v1/wallet
``` 
